<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Checkout - SVIST</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .pay-box { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        #qrImg { width: 220px; height: 220px; margin: 20px 0; border: 1px solid #eee; padding: 10px; border-radius: 15px; }
        .btn-pay { background: #6366f1; color: white; border: none; width: 100%; padding: 18px; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; }
        input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="pay-box">
    <h2 id="bName">Loading...</h2>
    <h1 id="bPrice">₹0</h1>
    <img id="qrImg" src="" alt="QR Code">
    <p style="color: #64748b; font-size: 14px;">Scan QR and enter Transaction ID (UTR)</p>
    
    <input type="text" id="utr" placeholder="Enter 12-digit UTR Number">
    <button class="btn-pay" onclick="completePurchase()">I HAVE PAID & UNLOCK</button>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const bName = params.get('batchName');
    const bPrice = params.get('price');
    const bUid = params.get('uid');

    document.getElementById('bName').innerText = bName;
    document.getElementById('bPrice').innerText = "₹" + bPrice;

    // Dynamic UPI QR Code (Google Charts API)
    const settings = JSON.parse(localStorage.getItem('svist_app_settings')) || {upi: 'svist@ybl'};
    const upiLink = `upi://pay?pa=${settings.upi}&pn=SVIST&am=${bPrice}&cu=INR`;
    document.getElementById('qrImg').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`;

    function completePurchase() {
        const utrVal = document.getElementById('utr').value.trim();
        if(utrVal.length < 10) return alert("Enter valid UTR!");

        // 1. INSTANT UNLOCK (ID SPECIFIC)
        const userKey = `unlocked_${bUid}`;
        let myBatches = JSON.parse(localStorage.getItem(userKey)) || [];
        if(!myBatches.includes(bName)) {
            myBatches.push(bName);
            localStorage.setItem(userKey, JSON.stringify(myBatches));
        }

        // 2. SEND TO ADMIN FOR RECORD
        let reqs = JSON.parse(localStorage.getItem('paymentRequests')) || [];
        reqs.push({
            userId: bUid,
            batchName: bName,
            utr: utrVal,
            date: new Date().toLocaleString(),
            status: "AUTO-UNLOCKED"
        });
        localStorage.setItem('paymentRequests', JSON.stringify(reqs));

        alert("Payment Verified! Batch Unlocked Successfully.");
        window.location.href = "paid-classes.html";
    }
</script>
</body>
</html>